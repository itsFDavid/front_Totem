<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem Photo - Tomar Foto</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <div class="app-container">
            <div class="header">
                <div class="header-content">
                    <h1>Totem Photo</h1>
                    <p>Captura tu momento</p>
                </div>

                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>

                <div class="dropdown-menu">
                    <a href="photos.html" class="dropdown-item"><i class="fas fa-images"></i> Galería Principal</a>
                    <a href="gallery.html" class="dropdown-item"><i class="fas fa-photo-video"></i> Mis Fotos</a>
                    <a href="qr.html" class="dropdown-item"><i class="fas fa-qrcode"></i> Escanear QR</a>
                    <a href="#" class="dropdown-item" data-modal-target="help-modal"><i
                            class="fas fa-question-circle"></i> Ayuda</a>
                    <a href="#" class="dropdown-item" data-modal-target="config-modal"><i class="fas fa-cog"></i>
                        Configuración</a>
                    <a href="index.html" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Salir</a>
                </div>
            </div>

            <div class="content">
                <div class="camera-layout">
                    <div id="templates-sidebar" class="templates-sidebar">
                        <h3 class="sidebar-title">Seleccionar Template</h3>
                        <div id="templates-grid-sidebar" class="templates-grid-sidebar">
                            </div>
                        <div id="template-message" style="color: #e879f9; text-align: center; margin-top: 10px;">Cargando...</div>
                    </div>

                    <div class="camera-container">
                        <h2 class="page-title">Tomar Foto</h2>

                        <div class="camera-preview">
                            <video id="camera-video" autoplay playsinline></video>
                            <canvas id="camera-canvas"></canvas>
                            <div id="countdown-overlay" class="countdown-overlay" style="display: none;">
                                <span id="countdown-number">3</span>
                            </div>
                            <div id="loading-overlay" class="loading-overlay" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Procesando imagen...</p>
                            </div>
                        </div>

                        <div class="camera-controls">
                            <button class="capture-btn" id="capture-btn" title="Capturar foto"></button>
                            <button id="switch-camera-btn" class="switch-camera-btn">
                                ↺
                            </button>

                        </div>

                        <div id="camera-message" style="text-align: center; margin-bottom: 20px; color: #e879f9;"></div>

                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <a href="gallery.html" class="btn" style="max-width: 200px; display: flex; align-items: center;">Ver Galería</a>
                            <a href="photos.html" class="btn" style="max-width: 200px;">Menú Principal</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="page-title">AYUDA</h2>
            <div class="page-text">
                <p>Bienvenido a la sección de ayuda de Totem Photo.</p>
                <p>Si tienes problemas para iniciar sesión, toma de fotos o cualquier otra función, no dudes en
                    contactarnos.</p>
                <p><strong>Email:</strong> support@totemphoto.com</p>
                <p><strong>Teléfono:</strong> +1 234 567 890</p>
            </div>
        </div>
    </div>

    <div id="config-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="page-title">CONFIGURACIÓN</h2>
            <div class="form-container" style="box-shadow: none; padding: 0;">
                <div class="form-group">
                    <label for="language">Idioma</label>
                    <select id="language">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quality">Calidad de imagen</label>
                    <select id="quality">
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Baja</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="notifications" checked style="width: auto;">
                    <label for="notifications" style="margin: 0;">Notificaciones</label>
                </div>
                <button class="btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- <script src="js/script.js"></script> -->
    <script>
        const API_BASE_URL = 'https://totem.itsfdavid.com';
        const API_TEMPLATES_ENDPOINT = '/templates/my'; 

        const video = document.getElementById('camera-video');
        const canvas = document.getElementById('camera-canvas');
        const captureBtn = document.getElementById('capture-btn');
        const messageDiv = document.getElementById('camera-message');
        const countdownOverlay = document.getElementById('countdown-overlay');
        const countdownNumber = document.getElementById('countdown-number');
        const loadingOverlay = document.getElementById('loading-overlay');
        const templatesGrid = document.getElementById('templates-grid-sidebar');
        const templateMessage = document.getElementById('template-message');
        let currentStream = null;
        let currentFacingMode = 'user'; // frontal por defecto

        let selectedTemplateId = null;

        // --- AUTENTICACIÓN Y FETCH ---
        function checkAuthentication() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = 'index.html'; 
                return null;
            }
            return token;
        }

        async function fetchData(endpoint) {
            const token = checkAuthentication();
            if (!token) return null;

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 401) {
                    localStorage.removeItem('accessToken');
                    window.location.href = 'index.html';
                    return null;
                }
                return [];
            } catch (error) {
                console.error('Error de red al obtener datos:', error);
                return [];
            }
        }

        // Función para cargar templates (Privados + Públicos)
            async function loadTemplates() {
                // 1. Cargar mis plantillas privadas
                const myTemplates = await fetchData('/templates/my') || [];

                // 2. Cargar plantillas públicas (del sistema)
                const publicTemplates = await fetchData('/templates/public') || [];

                // 3. Combinar ambas listas (ponemos las públicas primero para que se vean al principio)
                const allTemplates = [...publicTemplates, ...myTemplates];

                templatesGrid.innerHTML = '';

                if (allTemplates.length === 0) {
                    templateMessage.textContent = 'No hay plantillas disponibles.';
                    captureBtn.disabled = true;
                    return;
                }

                templateMessage.textContent = 'Selecciona una plantilla.';

                allTemplates.forEach((template, index) => {
                    const item = document.createElement('div');
                    item.className = 'template-selection-item';
                    item.dataset.uuid = template.uuid;

                    // Agregamos un pequeño punto rosa si es una plantilla pública/sistema
                    let publicBadge = "";
                    if (template.is_public) {
                        publicBadge = `<div style="position:absolute; top:5px; right:5px; background:#e879f9; color:white; font-size:10px; padding:2px 6px; border-radius:10px; z-index:2; box-shadow:0 2px 4px rgba(0,0,0,0.5);">Sistema</div>`;
                    }

                    // Renderizamos la imagen y el badge
                    item.innerHTML = `
                    ${publicBadge}
                    <img src="${template.url}" alt="Template ${index + 1}">
                `;

                    item.addEventListener('click', () => {
                        document.querySelectorAll('.template-selection-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedTemplateId = template.uuid;
                        captureBtn.disabled = false;
                        messageDiv.textContent = 'Plantilla seleccionada. ¡Lista para capturar!';
                    });

                    templatesGrid.appendChild(item);

                    // Seleccionar la primera por defecto
                    if (index === 0) {
                        item.click();
                    }
                });
            }
        
        // --- FUNCIÓN DE TEMPORIZADOR ---
        function startCountdown(duration) {
            return new Promise((resolve) => {
                let timer = duration;
                countdownNumber.textContent = timer;
                countdownOverlay.style.display = 'flex';
                captureBtn.disabled = true;

                const interval = setInterval(() => {
                    timer--;
                    countdownNumber.textContent = timer;
                    if (timer <= 0) {
                        clearInterval(interval);
                        countdownOverlay.style.display = 'none';
                        resolve();
                    }
                }, 1000);
            });
        }
        
        // --- FUNCIÓN DE CAPTURA Y INTEGRACIÓN ---
        async function captureAndIntegrate() {
            if (!selectedTemplateId) {
                messageDiv.textContent = 'Por favor, selecciona una plantilla antes de capturar.';
                messageDiv.style.color = '#ff6b6b';
                return;
            }

            // 1. Iniciar Temporizador
            await startCountdown(3); 
            console.log(video.videoWidth, video.videoHeight);

         const TARGET_WIDTH = 1080;
            const TARGET_HEIGHT = 1350;

            canvas.width = TARGET_WIDTH;
            canvas.height = TARGET_HEIGHT;

            const ctx = canvas.getContext("2d");

            //  NUNCA mirror en PC
            ctx.save();

            // Escalar manteniendo aspecto
            const scale = Math.max(
                TARGET_WIDTH / video.videoWidth,
                TARGET_HEIGHT / video.videoHeight
            );

            const drawWidth = video.videoWidth * scale;
            const drawHeight = video.videoHeight * scale;

            const offsetX = (TARGET_WIDTH - drawWidth) / 2;
            const offsetY = (TARGET_HEIGHT - drawHeight) / 2;

            ctx.drawImage(video, offsetX, offsetY, drawWidth, drawHeight);
            ctx.restore();


            const photoDataURL = canvas.toDataURL('image/jpeg', 0.95);
            
            // Flash effect
            canvas.style.display = 'block';
            setTimeout(() => {
                canvas.style.display = 'none';
                ctx.clearRect(0, 0, canvas.width, canvas.height); 
            }, 100);
            
            // 3. Preparar Subida
            loadingOverlay.style.display = 'flex';
            captureBtn.disabled = true;
            messageDiv.textContent = 'Foto capturada. Enviando para integración...';
            
            // Convertir Data URL a Blob/File
            const blob = await (await fetch(photoDataURL)).blob();
            const photoFile = new File([blob], "photo.jpg", { type: "image/jpeg" });

            // 4. Integrar con la API
            const token = checkAuthentication();
            if (!token) return;

            const formData = new FormData();
            formData.append('file', photoFile);

            try {
                const endpoint = `/templates/integrate/${selectedTemplateId}`;
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                    },
                    body: formData,
                });

                const data = await response.json();

                if (response.ok) {
                    // 5. Generar URL de Imagen y Redirigir a QR
                    const imageUuid = data.uuid;
                    // Decodificar token para obtener user_id
                    const tokenPayload = JSON.parse(atob(token.split('.')[1]));
                    const userId = tokenPayload.user_id || tokenPayload.sub; // Usa sub si user_id no existe
                    
                    const qrUrlBase = `${API_BASE_URL}/templates/image/${userId}/${imageUuid}.png`;

                    localStorage.setItem('lastPhotoUrl', qrUrlBase);
                    
                    messageDiv.textContent = '¡Integración exitosa! Generando QR...';
                    // esperar 5 segundos
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    window.location.href = `qr.html?url=${encodeURIComponent(qrUrlBase)}`;
                    
                } else {
                    messageDiv.textContent = `Error en integración: ${data.detail || 'Fallo desconocido'}`;
                    messageDiv.style.color = '#ff6b6b';
                }

            } catch (error) {
                console.error('Error al subir/integrar:', error);
                messageDiv.textContent = 'Error de conexión o integración. Intenta de nuevo.';
                messageDiv.style.color = '#ff6b6b';
            } finally {
                loadingOverlay.style.display = 'none';
                captureBtn.disabled = false;
            }
        }


        // Initialize camera
        async function startCamera() {
                const token = checkAuthentication();
                if (!token) return;

                // Detener stream previo
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                    currentStream = null;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            facingMode: { exact: currentFacingMode }
                        },
                        audio: false
                    });

                    video.srcObject = stream;
                    currentStream = stream;

                    messageDiv.textContent = 'Cámara lista. Selecciona una plantilla.';

                    // Cargar templates solo la primera vez
                    if (!templatesGrid.hasChildNodes()) {
                        loadTemplates();
                    }

                } catch (err) {
                    // Fallback si exact no funciona (muy común)
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: currentFacingMode },
                            audio: false
                        });

                        video.srcObject = stream;
                        currentStream = stream;
                        messageDiv.textContent = 'Cámara lista. Selecciona una plantilla.';

                    } catch (finalErr) {
                        console.error('Error accessing camera:', finalErr);
                        messageDiv.textContent = 'Error: No se pudo acceder a la cámara.';
                        messageDiv.style.color = '#ff6b6b';
                        captureBtn.disabled = true;
                    }
                }
            }


        async function checkMultipleCameras() {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoInputs = devices.filter(d => d.kind === 'videoinput');

                if (videoInputs.length < 2) {
                    const btn = document.getElementById('switch-camera-btn');
                    if (btn) btn.style.display = 'none';
                }
            }

        startCamera().then(checkMultipleCameras);

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'user'
                ? 'environment'
                : 'user';
            startCamera();
        }

        document.getElementById('switch-camera-btn').addEventListener('click', switchCamera);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            captureBtn.addEventListener('click', captureAndIntegrate);
            captureBtn.disabled = true;
            startCamera();
        });
    </script>
</body>

</html>