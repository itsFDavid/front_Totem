<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Totem Photo - QR</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>

<body>
  <div class="container">
    <div class="app-container">
      <div class="header">
        <div class="header-content">
          <h1>Totem Photo</h1>
          <p>Escanea para conectar</p>
        </div>

        <button class="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>

        <div class="dropdown-menu">
          <a href="photos.html" class="dropdown-item"><i class="fas fa-images"></i> Galería Principal</a>
          <a href="take-photo.html" class="dropdown-item"><i class="fas fa-camera"></i> Tomar Foto</a>
          <a href="gallery.html" class="dropdown-item"><i class="fas fa-photo-video"></i> Mis Fotos</a>
          <a href="#" class="dropdown-item" data-modal-target="help-modal"><i class="fas fa-question-circle"></i>
            Ayuda</a>
          <a href="#" class="dropdown-item" data-modal-target="config-modal"><i class="fas fa-cog"></i>
            Configuración</a>
          <a href="index.html" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Salir</a>
        </div>
      </div>

      <div class="content">
        <div class="qr-container"
          style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh;">
          <h2 class="qr-title" style="margin-bottom: 20px; font-size: 2rem; color: #e879f9;">Scan me!</h2>

          <div id="qrcode-display" class="qr-code"
            style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;"></div>

          <p style="font-size: 1.2rem; margin-bottom: 30px; text-align: center;">
            Escanea para descargar tu foto
          </p>

          <div class="timer-display"
            style="text-align: center; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; width: 100%; max-width: 400px;">
            <p id="timer-message" style="font-size: 1.1rem; margin-bottom: 15px;">
              Regresando a <i class="fas fa-camera"></i> en <span id="countdown-timer"
                style="color: #e879f9; font-weight: bold;">30</span> segundos...
            </p>

            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
              <a href="take-photo.html" class="btn" style="width: auto; min-width: 150px;">
                Nueva Foto
              </a>
              <a href="photos.html" class="btn"
                style="background-color: rgba(255,255,255,0.2); width: auto; min-width: 150px;">
                Menú
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="help-modal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2 class="page-title">AYUDA</h2>
      <div class="page-text">
        <p>...</p>
      </div>
    </div>
  </div>
  <div id="config-modal" class="modal">
    <div class="modal-content">
      <button class="close-modal">&times;</button>
      <h2 class="page-title">CONFIGURACIÓN</h2>
      <div class="form-container" style="box-shadow: none; padding: 0;">
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // 1. Intentar obtener URL de los parámetros (prioridad alta)
      const urlParams = new URLSearchParams(window.location.search);
      let imageUrl = urlParams.get('url');

      // 2. Si no hay parámetros, intentar recuperar la última foto tomada (prioridad media)
      if (!imageUrl) {
        imageUrl = localStorage.getItem('lastPhotoUrl');
      }

      const qrTargetDiv = document.getElementById('qrcode-display');
      const titleText = document.querySelector('.qr-title');
      const descText = document.querySelector('p[style*="font-size: 1.2rem"]');

      if (imageUrl) {
        const decodedUrl = decodeURIComponent(imageUrl);

        // Generar QR
        if (window.QRCode) {
          qrTargetDiv.innerHTML = "";
          new QRCode(qrTargetDiv, {
            text: decodedUrl,
            width: 280,
            height: 280,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.L
          });
        }
      } else {
        // 3. Caso: No hay parámetros Y no hay foto en memoria
        titleText.textContent = "Sin Fotos";
        qrTargetDiv.innerHTML = '<div style="padding:40px; text-align:center; color:#555;"><i class="fas fa-camera-retro" style="font-size:3rem; margin-bottom:10px;"></i><br>No has tomado ninguna foto aún.</div>';
        descText.textContent = "Ve a 'Tomar Foto' para empezar";

        // Opcional: Ocultar el temporizador si no hay foto
        const timerDisplay = document.querySelector('.timer-display');
        if (timerDisplay) timerDisplay.style.display = 'none';
      }

      // --- CONFIGURACIÓN DEL TEMPORIZADOR ---
      // Solo activar cuenta regresiva si estamos mostrando una foto
      if (imageUrl) {
        const DURATION = 30;
        const countdownTimer = document.getElementById('countdown-timer');
        let timeLeft = DURATION;

        const redirectTimeout = setTimeout(() => {
          window.location.href = 'take-photo.html';
        }, DURATION * 1000);

        const countdownInterval = setInterval(() => {
          timeLeft--;
          if (countdownTimer) countdownTimer.textContent = timeLeft;
          if (timeLeft <= 0) clearInterval(countdownInterval);
        }, 1000);

        document.querySelectorAll('a, button').forEach(el => {
          el.addEventListener('click', () => {
            clearTimeout(redirectTimeout);
            clearInterval(countdownInterval);
          });
        });
      }

      // Menú
      const menuToggle = document.querySelector('.menu-toggle');
      const dropdownMenu = document.querySelector('.dropdown-menu');
      if (menuToggle) {
        menuToggle.addEventListener('click', () => dropdownMenu.classList.toggle('show'));
      }
    });
  </script>
</body>

</html>