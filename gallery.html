<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem Photo - Mis Fotos</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<style>
    .gallery-item-actions button.delete-btn {
    color: #ff6b6b; /* Rojo para el botón de borrar */
}
.gallery-item-actions button.delete-btn:hover {
    color: #ff4c4c;
    transform: scale(1.1);
}
</style>

<body>
    <div class="container">
        <div class="app-container">
            <div class="header">
                <div class="header-content">
                    <h1>Totem Photo</h1>
                    <p>Tus recuerdos</p>
                </div>

                <!-- Dropdown Menu Toggle -->
                <button class="menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- Dropdown Menu -->
                <div class="dropdown-menu">
                    <a href="photos.html" class="dropdown-item"><i class="fas fa-images"></i> Galería Principal</a>
                    <a href="take-photo.html" class="dropdown-item"><i class="fas fa-camera"></i> Tomar Foto</a>
                    <a href="qr.html" class="dropdown-item"><i class="fas fa-qrcode"></i> Escanear QR</a>
                    <a href="#" class="dropdown-item" data-modal-target="help-modal"><i
                            class="fas fa-question-circle"></i> Ayuda</a>
                    <a href="#" class="dropdown-item" data-modal-target="config-modal"><i class="fas fa-cog"></i>
                        Configuración</a>
                    <a href="index.html" class="dropdown-item"><i class="fas fa-sign-out-alt"></i> Salir</a>
                </div>
            </div>

            <div class="content">
                <div class="gallery-container">
                    <h2 class="page-title">Mis Fotos</h2>

                    <div id="gallery-grid" class="gallery-grid">
                        <!-- Photos will be loaded here dynamically -->
                    </div>

                    <div id="empty-gallery" class="empty-gallery" style="display: none;">
                        <i class="fas fa-images"></i>
                        <p>No hay fotos aún</p>
                        <p>Toma tu primera foto para comenzar</p>
                        <a href="take-photo.html" class="btn" style="max-width: 200px; margin: 20px auto;">Tomar
                            Foto</a>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <a href="take-photo.html" class="btn" style="max-width: 200px; display: inline-block;">Tomar
                            Nueva Foto</a>
                        <a href="photos.html" class="btn"
                            style="max-width: 200px; display: inline-block; margin-left: 10px;">Menú Principal</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Viewer -->
    <div id="photo-viewer" class="photo-viewer">
        <button class="photo-viewer-close">&times;</button>
        <img id="viewer-image" src="" alt="Photo">
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="page-title">AYUDA</h2>
            <div class="page-text">
                <p>Bienvenido a la sección de ayuda de Totem Photo.</p>
                <p>Si tienes problemas para iniciar sesión, toma de fotos o cualquier otra función, no dudes en
                    contactarnos.</p>
                <p><strong>Email:</strong> support@totemphoto.com</p>
                <p><strong>Teléfono:</strong> +1 234 567 890</p>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="modal">
        <div class="modal-content">
            <button class="close-modal">&times;</button>
            <h2 class="page-title">CONFIGURACIÓN</h2>
            <div class="form-container" style="box-shadow: none; padding: 0;">
                <div class="form-group">
                    <label for="language">Idioma</label>
                    <select id="language">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quality">Calidad de imagen</label>
                    <select id="quality">
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Baja</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="notifications" checked style="width: auto;">
                    <label for="notifications" style="margin: 0;">Notificaciones</label>
                </div>
                <button class="btn">Guardar</button>
            </div>
        </div>
    </div>

    <!-- <script src="js/script.js"></script> -->
    <script>
        const API_BASE_URL = 'https://totem.itsfdavid.com';
        const API_ENDPOINT = '/templates/my-with-images'; // Ruta para imágenes integradas

        // 1. FUNCIÓN DE UTILIDAD: Autenticación
        function checkAuthentication() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = 'index.html'; 
                return null;
            }
            return token;
        }

        // 2. FUNCIÓN DE UTILIDAD: Llamada Genérica a la API (solo para obtener el JSON de URLs)
        async function fetchData(endpoint) {
            const token = checkAuthentication();
            if (!token) return null;

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    return await response.json();
                } else if (response.status === 401) {
                    localStorage.removeItem('accessToken');
                    window.location.href = 'index.html';
                    return null;
                } else {
                    console.error(`Error al obtener ${endpoint}:`, response.status, response.statusText);
                    return []; 
                }
            } catch (error) {
                console.error('Error de red al obtener datos:', error);
                return [];
            }
        }


        // 3. FUNCIÓN PRINCIPAL: Cargar Imágenes Integradas de la API (Método Directo)
        async function loadIntegratedImages() {
            const galleryGrid = document.getElementById('gallery-grid');
            const emptyGallery = document.getElementById('empty-gallery');
            
            // Obtener datos de la API (solo la lista de URLs)
            const images = await fetchData(API_ENDPOINT);

            galleryGrid.innerHTML = '';
            
            if (!images || images.length === 0) {
                emptyGallery.style.display = 'block';
                galleryGrid.style.display = 'none';
                return;
            }

            emptyGallery.style.display = 'none';
            galleryGrid.style.display = 'grid';
            
            // Renderizar las imágenes usando la URL directa
            images.forEach((img, index) => {
                const imageUrl = img.url; 
                const uuid = img.uuid; 
                
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // --- CREACIÓN DEL ELEMENTO IMG ---
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = `Photo ${index + 1}`;
                
                // ASIGNAR EL EVENTO CLICK DIRECTO A LA IMAGEN
                imgElement.addEventListener('click', () => {
                    viewPhoto(uuid, imageUrl);
                });
                
                // Contenedor de acciones
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'gallery-item-actions';
                
                actionsDiv.innerHTML = `
                    <button onclick="downloadPhoto('${uuid}', '${imageUrl}')" title="Descargar"><i class="fas fa-download"></i></button>
                    <button onclick="deletePhoto('${uuid}')" class="delete-btn" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
                `;
                
                // Montar el item:
                item.appendChild(imgElement);
                item.appendChild(actionsDiv);

                galleryGrid.appendChild(item);
            });
        }

        // View photo in fullscreen
        function viewPhoto(uuid, url) {
            const viewer = document.getElementById('photo-viewer');
            const img = document.getElementById('viewer-image');
            img.src = url;
            viewer.classList.add('show');
        }

        // Download photo
        function downloadPhoto(uuid, url) {
            // NOTA: Para descargar una imagen de una URL externa, 
            // generalmente necesitas una ruta proxy en el backend o que la cabecera CORS 
            // permita la descarga. Aquí usamos un truco de enlace directo.
            const link = document.createElement('a');
            link.href = url;
            link.download = `totem-photo-${uuid}.png`;
            link.target = "_blank"; // Abrir en nueva pestaña si falla la descarga directa
            link.click();
        }

        // Delete photo 
        async function deletePhoto(uuid) {
            if (!confirm(`¿Estás seguro de que quieres eliminar esta imagen?`)) {
                return;
            }

            const token = checkAuthentication();
            if (!token) return;

            try {
                // Hacemos la petición DELETE al backend
                const response = await fetch(`${API_BASE_URL}/templates/image/${uuid}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    // Si se borró correctamente, eliminamos el elemento visualmente sin recargar
                    // Buscamos el botón que se presionó y subimos hasta el contenedor .gallery-item
                    // Nota: Como no tenemos referencia directa al elemento aquí, recargaremos la lista
                    // O mejor, buscamos el elemento por UUID si asignamos IDs, pero recargar es más seguro:
                    loadIntegratedImages(); 
                    
                    // Opcional: Mostrar notificación
                    alert("Imagen eliminada correctamente");
                } else {
                    alert("Error al eliminar la imagen");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error de conexión al eliminar");
            }
        }


        // Close photo viewer
        document.querySelector('.photo-viewer-close').addEventListener('click', function () {
            document.getElementById('photo-viewer').classList.remove('show');
        });

        document.getElementById('photo-viewer').addEventListener('click', function (e) {
            if (e.target === this) {
                this.classList.remove('show');
            }
        });

        // Load gallery on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadIntegratedImages();
        });
    </script>
</body>

</html>